<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd" >

<html xmlns = "http://www.w3.org/1999/xhtml"xml: lang = "en" >
<head >
<title > demo </title>
  <link rel="stylesheet" href="stylesheets/screen.css" type="text/css" media="screen" charset="utf-8">
  
	<script src="javascripts/jquery.1.4.2.js" type="text/javascript " charset="utf - 8 "></script>
  <script src = "javascripts/demo.js"type = "text/javascript"charset = "utf-8" > </script>
  <script type="text/javascript " src="http://maps.google.com/maps/api/js?sensor=false"></script>
	
	<script type="text/javascript " charset="utf-8 ">
    var points = [];
    var points_clean = [];
    var MAX_D = 300.0;
    var MIN_D = 40;
    var flickr_data; // data from flickr.com
    var keywords = "Plaka Athens";
    var loading_starting_timepoint, loading_ending_timepoint, cpu_starting_timepoint, cpu_ending_timepoint, cpu_elapsed_time, loading_elapsed_time;
    
    rad = function(x) {return x*Math.PI/180;}
    
    function distance(p1, p2) {
       var R = 6371; // earth's mean radius in km
       var dLat  = rad(p2.latitude - p1.latitude);
       var dLong = rad(p2.longitude - p1.longitude);

       var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
               Math.cos(rad(p1.latitude)) * Math.cos(rad(p2.latitude)) * Math.sin(dLong/2) * Math.sin(dLong/2);
       var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
       var d = R * c;
       return (d*1000);
    }

    function find_central_latlng(points) {
      // average central point LAT - LNG
      central_lat_sum = 0.0;
      central_lng_sum = 0.0;
      for (var k=0; k < points.length; k++) {
        central_lat_sum += points[k].latitude;
        central_lng_sum += points[k].longitude;
      };
      central_lng = central_lng_sum/points.length;
      central_lat = central_lat_sum/points.length;
      central_latlng = new google.maps.LatLng(central_lat, central_lng);
      return central_latlng;
    }

    function jsonFlickrApi(data) {
      flickr_data = data;
      $('div.loading_wrapper').fadeOut();
      
      // json responce HANDLER
      loading_finishing_timepoint = new Date();    
      cpu_starting_timepoint = new Date();
      points = data.photos.photo;
      $('#points_length').text(points.length);
      points_clean = [];
      
      for(i=0; i < points.length; i++) {
        current_point = points[i];
        for(k = i; k < points.length; k++) {
          next_point = points[k];
          dist = distance(current_point, next_point);
          if (dist < MAX_D && dist > 0) {
            
            if (current_point.degree) {
              current_point.degree+=1;
            } else {
              current_point.degree=1;
            }

            if (next_point.degree) {
              next_point.degree+=1;
            } else {
              next_point.degree=1;
            }
            
          } // end if distance < MAX DISTANCE
        } // end k loop
      } // end i loop


      // Removing Items with degree < MINIMUM DEGREE
      for(i=0; i < points.length; i++) {
        if ((points[i].degree+"") != ""  && points[i].degree > MIN_D ) {
          console.log(points[i].degree);
          points_clean.push(points[i]);
        } 
      }
      $('#points_clean_length').text(points_clean.length);
      
      var central_latlng = find_central_latlng(points_clean);
      
      
      // DEFINING THE MAP
      var myOptions = {
        zoom: 15,
        center: central_latlng,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      };
      var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
      
      
      // PRINTING THE MARKERS
      for (var k=0; k < points_clean.length; k++) {
        my_marker = new google.maps.Marker({
          position: new google.maps.LatLng(points_clean[k].latitude, points_clean[k].longitude),
          map: map,
          title: "Degree = "+points_clean[k].degree+""
        });  
      }
      
      // PRINTING THE CENTRAL MARKER
      central_marker = new google.maps.Marker({
        position: central_latlng,
        map: map,
        title: "Center of CLUSTER",
        icon: new google.maps.MarkerImage({url: "http://labs.google.com/ridefinder/images/mm_20_purple.png"})
      });  
      
      
      cpu_finishing_timepoint = new Date();
      cpu_elapsed_time = (cpu_finishing_timepoint - cpu_starting_timepoint);
      loading_elapsed_time = (loading_finishing_timepoint - loading_starting_timepoint);
      $("span#cpu_time").text(cpu_elapsed_time+" ms");
      $("span#loading_time").text(loading_elapsed_time+" ms");
    } // end function jsonFlickrApi

	 
 </script>
 <style type="text/css" media="screen">
  table.info {
    
  }
    table.info td {
      color: #444;
    }
      table.info td span {
        font-weight: bold;
        color: #000;
      }
 </style>
</head >
<body >
  <div class="loading_wrapper" style="display:none">
  	<div class="loading">
  		<div class="loading_content">Waiting for Flickr.com</div>
  	</div>
  </div>
  
  <table class="info">
    <tr>
      <td>
        <form action="" method="get" accept-charset="utf-8">
          <input type="text" name="keywords" value="" id="keywords" /> 
          <input type="submit" value="Search &rarr;" />
        </form>
      </td>
      <td> || </td>
      <td>Cluster Points: <span id="points_clean_length"></span> of <span id="points_length"></span></td>
      <td> || </td>
      <td>Process Time: <span id="cpu_time"></span></td>
      <td> || </td>
      <td>Loading Time: <span id="loading_time"></span></td>
    </tr>
  </table>
  
  <div id="map_canvas" style="height:600px; width: 100%" > </div>
  
  <script type="text/javascript" charset="utf-8">
    $(document).ready(function() {
      loc = window.location.href
      keywords = loc.substr(loc.indexOf("=")+1, loc.length);
      $('input#keywords').val(keywords+"");
      $('div.loading_wrapper').show();
      loading_starting_timepoint = new Date();    
      $.getJSON("http://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=656222a441d1f6305791eeee478796d0&text="+
      keywords+
      "&has_geo=true" +
      "&extras=geo" +
      "&sort=interestingness-desc&format=json&outlier=?");
    });
  </script>
</body >
</html>